<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Dynamic Marker Viewer</title>
<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; }
.popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 800px;
  background: #000;
  border-radius: 8px;
  display: none;
  z-index: 100;
  padding: 0;
}
.closeBtn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: red;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  cursor: pointer;
  z-index: 101;
}
iframe, img { width: 100%; height: 400px; border-radius: 0 0 8px 8px; display: block; border: none; }
</style>
</head>
<body>

<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' id="scene">
  <a-entity camera></a-entity>
</a-scene>

<script>
let popupActive = false;

// 讀取 markerConfig.json
fetch('markerConfig.json')
  .then(res => res.json())
  .then(config => {
    const scene = document.getElementById('scene');

    config.forEach(marker => {
      const markerEl = document.createElement('a-marker');
      marker.type === 'preset' ? markerEl.setAttribute('preset', marker.id)
                                : markerEl.setAttribute('type', 'pattern');
      if(marker.type === 'pattern') markerEl.setAttribute('url', marker.patternFile || '');

      scene.appendChild(markerEl);

      // 創建 popup
      const popup = document.createElement('div');
      popup.className = 'popup';
      popup.id = 'popup-' + marker.id;

      const closeBtn = document.createElement('button');
      closeBtn.className = 'closeBtn';
      closeBtn.innerText = '關閉';
      closeBtn.onclick = () => {
        popup.style.display = 'none';
        if(marker.contentType === 'video') popup.querySelector('iframe').src = '';
        popupActive = false;
      };
      popup.appendChild(closeBtn);

      if(marker.contentType === 'video') {
        const iframe = document.createElement('iframe');
        iframe.src = marker.videoUrl;
        iframe.allow = "autoplay; encrypted-media";
        iframe.allowFullscreen = true;
        popup.appendChild(iframe);
      } else if(marker.contentType === 'image') {
        const img = document.createElement('img');
        img.src = marker.imageFile;
        popup.appendChild(img);
      }

      document.body.appendChild(popup);

      // marker 偵測事件
      markerEl.addEventListener('markerFound', () => {
        if(!popupActive) {
          popup.style.display = 'block';
          if(marker.contentType === 'video') popup.querySelector('iframe').src = marker.videoUrl + "?autoplay=1";
          popupActive = true;
        }
      });
    });
  });
</script>

</body>
</html>
